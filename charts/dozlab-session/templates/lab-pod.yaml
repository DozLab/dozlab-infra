apiVersion: v1
kind: Pod
metadata:
  name: lab-session-{{ .Values.session.id }}
  labels:
    app: lab-environment
    session-id: {{ .Values.session.id | quote }}
    user-id: {{ .Values.session.userId | quote }}
    {{- with .Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  initContainers:
  # Rootfs preparation using init-setup from dozlab-rootfs-manager
  # https://github.com/DozLab/dozlab-rootfs-manager/tree/main/init-setup
  - name: init-rootfs
    image: {{ .Values.initContainers.rootfs.image }}:{{ .Values.initContainers.rootfs.tag }}
    env:
    - name: IMAGE_DOWNLOAD_URL
      value: {{ .Values.rootfs.imageUrl | quote }}
    - name: IMAGE_SIZE
      value: {{ .Values.rootfs.diskSize | quote }}
    - name: IMAGE_PATH
      value: "/srv/vm/kernels/rootfs.ext4"
    volumeMounts:
    - name: vm-kernels
      mountPath: /srv/vm/kernels
    resources:
      {{- toYaml .Values.initContainers.rootfs.resources | nindent 6 }}

  # Network configuration calculator
  - name: network-setup
    image: {{ .Values.initContainers.network.image }}:{{ .Values.initContainers.network.tag }}
    command:
    - sh
    - -c
    - |
      echo "Configuring network for Firecracker VM..."
      POD_IP=$(hostname -i)
      echo "Pod IP: $POD_IP"

      # Network configuration for Firecracker
      # VM will use {{ .Values.network.vmIp }}, Gateway {{ .Values.network.gatewayIp }}
      echo "GATEWAY_IP={{ .Values.network.gatewayIp }}" > /shared/network-config
      echo "VM_IP={{ .Values.network.vmIp }}" >> /shared/network-config
      echo "POD_IP=$POD_IP" >> /shared/network-config
      echo "TAP_DEVICE={{ .Values.network.tapDevice }}" >> /shared/network-config

      echo "Network configuration written to /shared/network-config"
      cat /shared/network-config
    volumeMounts:
    - name: shared-config
      mountPath: /shared
    resources:
      {{- toYaml .Values.initContainers.network.resources | nindent 6 }}

  containers:

  # Firecracker MicroVM container
  - name: firecracker-vm
    image: {{ .Values.firecracker.image }}:{{ .Values.firecracker.tag }}
    securityContext:
      # Use specific capabilities instead of privileged mode
      capabilities:
        add:
        - NET_ADMIN      # Required for tap device and iptables
        - SYS_ADMIN      # Required for mounting and VM operations
        - SYS_RESOURCE   # Required for setting resource limits
      # Remove privileged: true for better security
    env:
    - name: SESSION_ID
      value: {{ .Values.session.id | quote }}
    - name: ROOTFS_PATH
      value: "/srv/vm/kernels/rootfs.ext4"
    - name: KERNEL_PATH
      value: "/find/vmlinux.bin"
    - name: CPU_COUNT
      value: {{ .Values.firecracker.vm.cpuCount | quote }}
    - name: MEMORY
      value: {{ .Values.firecracker.vm.memory | quote }}
    - name: GATEWAY_IP
      value: {{ .Values.network.gatewayIp | quote }}
    - name: VM_IP
      value: {{ .Values.network.vmIp | quote }}
    - name: TAP_DEVICE_NAME
      value: {{ .Values.network.tapDevice | quote }}
    ports:
    - containerPort: 22
      name: vm-ssh
      protocol: TCP
    resources:
      {{- toYaml .Values.firecracker.resources | nindent 6 }}
    volumeMounts:
    - name: vm-kernels
      mountPath: /srv/vm/kernels
    - name: vm-data
      mountPath: /vm-data
    - name: shared-config
      mountPath: /shared
      readOnly: true
    livenessProbe:
      tcpSocket:
        port: 22
      initialDelaySeconds: {{ .Values.firecracker.livenessProbe.initialDelaySeconds }}
      periodSeconds: {{ .Values.firecracker.livenessProbe.periodSeconds }}
      timeoutSeconds: {{ .Values.firecracker.livenessProbe.timeoutSeconds }}
      failureThreshold: {{ .Values.firecracker.livenessProbe.failureThreshold }}
    readinessProbe:
      tcpSocket:
        port: 22
      initialDelaySeconds: {{ .Values.firecracker.readinessProbe.initialDelaySeconds }}
      periodSeconds: {{ .Values.firecracker.readinessProbe.periodSeconds }}
      timeoutSeconds: {{ .Values.firecracker.readinessProbe.timeoutSeconds }}

  # Terminal sidecar container
  - name: terminal-sidecar
    image: {{ .Values.terminal.image }}:{{ .Values.terminal.tag }}
    ports:
    - containerPort: 8081
      name: terminal
      protocol: TCP
    env:
    - name: SESSION_ID
      value: {{ .Values.session.id | quote }}
    - name: VM_IP
      value: {{ .Values.network.vmIp | quote }}
    - name: VM_SSH_PORT
      value: "22"
    resources:
      {{- toYaml .Values.terminal.resources | nindent 6 }}
    volumeMounts:
    - name: vm-data
      mountPath: /vm-data
      readOnly: true
    - name: shared-config
      mountPath: /shared
      readOnly: true
    livenessProbe:
      httpGet:
        path: {{ .Values.terminal.livenessProbe.path }}
        port: 8081
      initialDelaySeconds: {{ .Values.terminal.livenessProbe.initialDelaySeconds }}
      periodSeconds: {{ .Values.terminal.livenessProbe.periodSeconds }}
    readinessProbe:
      httpGet:
        path: {{ .Values.terminal.readinessProbe.path }}
        port: 8081
      initialDelaySeconds: {{ .Values.terminal.readinessProbe.initialDelaySeconds }}
      periodSeconds: {{ .Values.terminal.readinessProbe.periodSeconds }}

  # VS Code Server container
  - name: code-server
    image: {{ .Values.codeServer.image }}:{{ .Values.codeServer.tag }}
    ports:
    - containerPort: 8080
      name: vscode
      protocol: TCP
    env:
    - name: PASSWORD
      valueFrom:
        secretKeyRef:
          name: lab-session-{{ .Values.session.id }}-secrets
          key: vscode-password
          optional: false
    - name: SESSION_ID
      value: {{ .Values.session.id | quote }}
    - name: DOCKER_HOST
      value: "tcp://{{ .Values.network.vmIp }}:2375"  # Connect to Docker daemon in VM
    command:
    - sh
    - -c
    - |
      # Start code-server with security headers
      exec code-server \
        --bind-addr 0.0.0.0:8080 \
        --auth password \
        --disable-telemetry \
        --disable-update-check \
        /workspace
    resources:
      {{- toYaml .Values.codeServer.resources | nindent 6 }}
    volumeMounts:
    - name: vscode-data
      mountPath: /home/coder
    - name: vm-data
      mountPath: /workspace
      # FIXED: Allow users to edit files in VS Code
      readOnly: {{ .Values.codeServer.workspaceReadOnly }}
    - name: shared-config
      mountPath: /shared
      readOnly: true
    livenessProbe:
      httpGet:
        path: {{ .Values.codeServer.livenessProbe.path }}
        port: 8080
      initialDelaySeconds: {{ .Values.codeServer.livenessProbe.initialDelaySeconds }}
      periodSeconds: {{ .Values.codeServer.livenessProbe.periodSeconds }}
    readinessProbe:
      httpGet:
        path: {{ .Values.codeServer.readinessProbe.path }}
        port: 8080
      initialDelaySeconds: {{ .Values.codeServer.readinessProbe.initialDelaySeconds }}
      periodSeconds: {{ .Values.codeServer.readinessProbe.periodSeconds }}
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false

  volumes:
  # Kernel and rootfs storage
  - name: vm-kernels
    emptyDir:
      sizeLimit: {{ .Values.volumes.kernels.sizeLimit }}

  # VM working data (EPHEMERAL - DATA LOST ON POD TERMINATION)
  - name: vm-data
    emptyDir:
      sizeLimit: {{ .Values.volumes.vmData.sizeLimit }}

  # VS Code configuration and extensions (EPHEMERAL - DATA LOST ON POD TERMINATION)
  - name: vscode-data
    emptyDir:
      sizeLimit: {{ .Values.volumes.vscodeData.sizeLimit }}

  # Shared configuration between containers
  - name: shared-config
    emptyDir:
      sizeLimit: {{ .Values.volumes.sharedConfig.sizeLimit }}

  restartPolicy: {{ .Values.restartPolicy }}

  # Pod-level security context
  securityContext:
    fsGroup: 1000
    runAsNonRoot: false  # Firecracker requires root
    seccompProfile:
      type: RuntimeDefault
